<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NLWCompare Report</title>

  <script type="text/javascript">

  function init() {

    let params = (new URL(document.location)).searchParams;

    var url = 'api/comparison?baseline='+params.get("baseline")+'&candidate='+params.get("candidate")
    $('#apisrc').attr('href',url);
    toggleDump();

    if(!isEmpty($("#dump").val()))
      processData();
    else if(isEmpty(params.get("baseline")))
      alert("This report requires a query parameter 'baseline' corresponding to a valid NeoLoad Web test ID.")
    else if(isEmpty(params.get("candidate")))
      alert("This report requires a query parameter 'candidate' corresponding to a valid NeoLoad Web test ID.")
    else
    {
      $.ajax({
          url: url,
          type: 'get',
          dataType: 'json',
          cache: false,
          success: function(data) {
            $("#dump").val(JSON.stringify(data,null,'\t'))
            processData();
          },
          error: function(xhr, status, error) {
            alert("An error occurred while obtaining report data.\n\n" + error)
          },
          complete: function(xhr, status) {
            $(".preloader").hide();
            //if(status != "success")
          },
          async:true,
      });
    }
  }

  function toggleDump() {
    var isVisible = $('#dump').is(":visible");
    $('#showDump').val((isVisible ? "Show" : "Hide") + " JSON dump")
    if(isVisible)
      $('#dump').css('height','80px').hide()
    else
      $('#dump').css('height','800px').show()
  }
  function isEmpty(val) {
    return (val == undefined || val == null || (val+"").trim().length < 1)
  }

  function processData(data) {
    $(".preloader").hide();

    var summaryTemplate = $("#baseSummary").html()
    $("#candSummary").html(summaryTemplate.replaceAll('"base','"cand'));
    $("#candTemplateName").html("Candidate")

    $("#timestamp").text((new Date()).toLocaleString())

    var data = JSON.parse($("#dump").val())

    populateSummary('base',data.baselineSummary)
    populateSummary('cand',data.candidateSummary)

    var nogo = (data.violations != undefined && data.violations != null
                && Array.isArray(data.violations) && data.violations.length > 0)
    var totalViolations = (data.violations.length > 0 ?
      data.violations
        .map(v => v.monitors)
        .reduce(function(arr,sub) { return arr.concat(sub) })
        .map(mon => 1)
        .reduce(function(sum,num) { return sum+num })
        : 0);
    $("#goNoGo").html(
      (nogo ? '<div class="nogo">NO-GO</div>' : '<div class="go">GO</div>') +
      (nogo ? '<div class="nogoreasons"><a href="#violations">'+totalViolations+' violation(s)</a></div>' : '')
      )

    $('#baseName').html('<a href="'+data.links.baseline.overview+'" target="_blank">'+data.baselineSummary.name+'</a>')
    $('#candName').html('<a href="'+data.links.candidate.overview+'" target="_blank">'+data.candidateSummary.name+'</a>')

    // go-no-go

    populatePercentileItems({ targetElement: $("#topTransactions"), items: data.topTransactions, itemType: 'Transaction',
      baseHeader: '<a href="'+data.links.baseline.transactions+'" target="_blank">Baseline<br />(perc)</a>',
      candHeader: '<a href="'+data.links.candidate.transactions+'" target="_blank">Candidate<br />(perc)</a>'
    })

    populatePercentileItems({ targetElement: $("#topResponses"), items: data.topRequests, itemType: 'Request',
      baseHeader: '<a href="'+data.links.baseline.requests+'" target="_blank">Baseline<br />(perc)</a>',
      candHeader: '<a href="'+data.links.candidate.requests+'" target="_blank">Candidate<br />(perc)</a>'
    })

    populatePercentileItems({ targetElement: $("#errorRates"), items: data.errorsByRequest, itemType: 'Failed Request',
      baseHeader: 'Baseline<br />(#)',
      candHeader: 'Candidate<br />(#)',
      labelKey: 'path',
      baseKey: 'baselineFailureCount',
      candKey: 'candidateFailureCount',
      varianceKey: 'varianceInFailureCount'
    })

    populatePercentileItems({ targetElement: $("#allTransactions"), items: data.transactionVariances, itemType: 'Transaction',
      fLabelProcessor: s => truncateText(s,80),
      baseHeader: '<a href="'+data.links.baseline.transactions+'" target="_blank">Baseline<br />(perc)</a>',
      candHeader: '<a href="'+data.links.candidate.transactions+'" target="_blank">Candidate<br />(perc)</a>'
    })

    populateViolationsItems({ targetElement: $("#violations"), items: data.violations,
      baseHeader: '<a href="'+data.links.baseline.counters+'" target="_blank">Baseline<br />(val)</a>',
      candHeader: '<a href="'+data.links.candidate.counters+'" target="_blank">Candidate<br />(val)</a>'
    })

    populatePercentileItems({ targetElement: $("#allRequests"), items: data.requests, itemType: 'Request',
      fLabelProcessor: s => truncateText(s,80),
      baseHeader: '<a href="'+data.links.baseline.requests+'" target="_blank">Baseline<br />(perc)</a>',
      candHeader: '<a href="'+data.links.candidate.requests+'" target="_blank">Candidate<br />(perc)</a>'
    })

  }


  function populateSummary(uiPrefix,data) {
    $('#'+uiPrefix+'Name').text(data.name)
    $('#'+uiPrefix+'StartDate').text((new Date(data.startDate)).toLocaleString())
    $('#'+uiPrefix+'Duration').text(time_convert(data.duration / 1000 / 60))
    $('#'+uiPrefix+'TPS').text(round(data.transactionsPerSecond,2))
    //$('#'+uiPrefix+'AvgRespTime').text(time_convert(data.averageResponseTime / 60,2))
    $('#'+uiPrefix+'Throughput').text(round(data.throughput,3)+'Mbs')
    $('#'+uiPrefix+'ErrorCount').text(data.errorCount)
  }
  function populateByTemplate(targetElement,items,fItemTemplate,fHeaderTemplate,fFooterTemplate) {
    var html = '';
    if(fHeaderTemplate != undefined && fHeaderTemplate != null && typeof fHeaderTemplate == 'function') html += fHeaderTemplate()
    $(items).each(function(i) {
      html += fItemTemplate(this);
    })
    if(fFooterTemplate != undefined && fFooterTemplate != null && typeof fFooterTemplate == 'function') html += fFooterTemplate()
    targetElement.html(html)
    return html;
  }
  function populatePercentileItems(opts) {
    var labelKey = isEmpty(opts.labelKey) ? 'path' : opts.labelKey;
    var baseKey = isEmpty(opts.baseKey) ? 'basePercentile' : opts.baseKey;
    var candKey = isEmpty(opts.candKey) ? 'candPercentile' : opts.candKey;
    var baseHeader = isEmpty(opts.baseHeader) ? 'Baseline' : opts.baseHeader;
    var candHeader = isEmpty(opts.candHeader) ? 'Candidate' : opts.candHeader;
    var varianceKey = isEmpty(opts.varianceKey) ? 'varianceInPercentile' : opts.varianceKey;

    return populateByTemplate(opts.targetElement,opts.items,function(item) {
      var gt = (item[baseKey]<item[candKey]);
      var lt = (item[baseKey]>item[candKey]);
      var eq = (item[baseKey]==item[candKey]);
      var baseClass = eq ? 'non-value' : lt ? 'bad-value' : 'good-value';
      var candClass = eq ? 'non-value' : gt ? 'bad-value' : 'good-value';
      var pathClass = candClass;
      var rowLabel = (opts.fLabelProcessor != undefined && opts.fLabelProcessor != null && typeof opts.fLabelProcessor == 'function') ?
        opts.fLabelProcessor(item[labelKey]) : truncateText(item[labelKey])

      var grouping = (typeof opts.fColumnGrouper == 'function') ? opts.fColumnGrouper(item) : null;
      return '<div class="rTableRow">'+
              (grouping == null ? '<div class="rTableCell row-label '+pathClass+'">'+rowLabel+'</div>' : '')+
              (grouping != null ? grouping.itemCells : '') +
              '<div class="rTableCell '+baseClass+' center">'+round(item[baseKey],3)+'</div>'+
              '<div class="rTableCell '+candClass+' center">'+round(item[candKey],3)+'</div>'+
              '<div class="rTableCell '+candClass+'">'+formatPercent(item[varianceKey],2)+'</div>'+
              '</div>'
    },function() {
      var grouping = (typeof opts.fColumnGrouper == 'function') ? opts.fColumnGrouper(opts.items[0]) : null;
      return '<div class="rTable">'+
              '<div class="rTableHeading">'+
              (grouping == null ? '<div class="rTableCell">'+opts.itemType+'</div>' : '')+
              (grouping != null ? grouping.headCells : '') +
              '<div class="rTableCell center">'+baseHeader+'</div>'+
              '<div class="rTableCell center">'+candHeader+'</div>'+
              '<div class="rTableCell"><em>Var</em></div>'+
              '</div>'
    },function() {
      return '</div>'
    })
  }
  //targetElement,items,itemType,fLabelProcessor,labelKey,baseKey,candKey,varianceKey,fColumnGrouper
  function populateViolationsItems(opts) {
    var targetElement = opts.targetElement;
    var violationGroups = opts.items;
    var html = ''
    $(violationGroups).each(function(i) {
      var grp = this;
      var criticals = grp.monitors.filter(mon => { return mon.violations != undefined && Array.isArray(mon.violations)})
          .filter(mon => { return mon.violations.filter(viol => viol.critical == true).length > 0})
      if(criticals.length > 0) {
        var thisHtml = '<div>'+
              '<div class="colbox">'+
                '<h4>'+criticals[0].violations[0].rule+'</h4>'+
                '<div class="onecol">'+
                ''+ populatePercentileItems(copyOver(opts,{
                  targetElement: $('#nonpresentElement'),
                  items: grp.monitors,
                  itemType: grp.violationType,
                  fColumnGrouper: function(itm) {
                    var template = {
                      headCells: itm.meta.heirarchy
                        .map(s => '<div class="rTableCell center">&nbsp;</div>').join('')
                    }
                    if(itm != undefined && itm != null)
                      template.itemCells = itm.meta.heirarchy
                        .map(s => '<div class="rTableCell center">'+s+'</div>').join('')
                      console.log(template)
                    return template;
                  }
                })) +
                '<div style="clear:both;float:none;">&nbsp;</div>'+
                '</div>'
              '</div>'+
              ''
          html += thisHtml;
      }
    })
    if(html.length < 1)
      html = 'No violations'
    targetElement.html(html)
    return html;
  }
  function truncateText(orig,len) {
    var max = 40;
    if(len == undefined || len == null || len < 1) len = max;
    var s = orig;
    if(s.length > len)
    {
      var half1 = Math.round(len / 2);
      var half2 = Math.round(len / 2);
      s = s.substring(0,half1) + '...' + s.substring(s.length-half2,s.length);
    }
    return s;
  }
  function round(num, scale) {
    if(scale == undefined || scale == null || scale < 0) scale = 0;
    if(!("" + num).includes("e")) {
      return +(Math.round(num + "e+" + scale)  + "e-" + scale);
    } else {
      var arr = ("" + num).split("e");
      var sig = ""
      if(+arr[1] + scale > 0) {
        sig = "+";
      }
      return +(Math.round(+arr[0] + "e" + sig + (+arr[1] + scale)) + "e-" + scale);
    }
  }
  String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
  };
  function time_convert(num,secRound)
  {
    if(secRound == undefined || secRound == null || secRound < 0) secRound = 0;
    var hours = Math.floor(num / 60);
    var minutes = num % 60;
    return (hours > 0 ? hours + "h:" : "") + round(minutes,secRound) + 'm';
  }
  function formatPercent(value,scale) {
    if(scale == undefined || scale == null || scale < 0) scale = 0;
    var val = value;
    if(val > 1 || val < -1) val /= 100;
    return round(value * 100,scale) + '%'
  }

  function copyOver(oldObj,newObj) {
    var ret = oldObj;
    for(var k in newObj) ret[k]=newObj[k];
    return ret;
  };

  </script>
</head>

<body>
  <div class="colbox">
    <div class="twocol">
      <h1>Performance Comparison</h1>
      <div class="timestamp">
        Reported on: <span id="timestamp" />
      </div>
    </div>
    <div class="twocol" style="text-align:right;padding-top:1em;">
      <img src="static/logo-neoload2.png" alt="NeoLoad" width="200" />
    </div>
  </div>

  <div style="clear:both;float:none;">&nbsp;</div>

  <div class="preloader">
    <img src="static/application-loading.gif" width="128" height="128" alt="loading..." />
  </div>

  <div class="colbox">
    <div class="threecol" id="baseSummary">
      <div class="rTable">
        <div class="rTableHeading">
          <div class="rTableCell row-label right-align"><h3 id="baseTemplateName">Baseline</h3></div>
          <div class="rTableCell [[summaryClass]]"><span id="baseName"></span></div>
        </div>
        <div class="rTableRow">
          <div class="rTableCell row-label right-align">TPS</div>
          <div class="rTableCell [[summaryClass]]"><span id="baseTPS"></span></div>
        </div>
        <div class="rTableRow">
          <div class="rTableCell row-label right-align">Started</div>
          <div class="rTableCell [[summaryClass]]"><span id="baseStartDate"></span></div>
        </div>
        <div class="rTableRow">
          <div class="rTableCell row-label right-align">Duration</div>
          <div class="rTableCell [[summaryClass]]"><span id="baseDuration"></span></div>
        </div>
        <!--div class="rTableRow">
          <div class="rTableCell row-label right-align">Avg Resp Time</div>
          <div class="rTableCell [[summaryClass]]"><span id="baseAvgRespTime"></span></div>
        </div-->
        <div class="rTableRow">
          <div class="rTableCell row-label right-align">Throughput</div>
          <div class="rTableCell [[summaryClass]]"><span id="baseThroughput"></span></div>
        </div>
        <div class="rTableRow">
          <div class="rTableCell row-label right-align">Errors</div>
          <div class="rTableCell [[summaryClass]]"><span id="baseErrorCount"></span></div>
        </div>
      </div>
    </div>
    <div class="threecol" id="goNoGo">
    </div>
    <div class="threecol" id="candSummary">
    </div>
  </div>

  <div style="clear:both;float:none;">&nbsp;</div>

  <h2>Top Indicators</h2>

  <div class="colbox">
    <div class="twocol">
      <div class="row">
        <h3>Transactions (var in req perc)</h3>
      </div>
      <div id="topTransactions"></div>
      <div class="row">
        <h3>Responses (var in duration)</h3>
      </div>
      <div id="topResponses"></div>
    </div>
    <!--div class="threecol">
      <div class="row">
        <h3>Call Count (by Host)</h3>
      </div>
      <div>
        [not yet implemented]
      </div>
    </div-->
    <div class="twocol">
      <div class="row">
        <h3>Error Rate</h3>
      </div>
      <div id="errorRates"></div>
    </div>
  </div>

  <a name="violations" />

  <div style="clear:both;float:none;">&nbsp;</div>

  <h2>Key Server Metrics</h2>

  <div class="colbox">
    <div class="onecol">
      <div id="violations"></div>
    </div>
  </div>

  <div style="clear:both;float:none;">&nbsp;</div>

  <h2>All Elements (Details)</h2>

  <div class="colbox">
    <div class="onecol">
      <div id="allTransactions"></div>
    </div>
  </div>

  <div style="clear:both;float:none;">&nbsp;</div>

  <div class="colbox">
    <div class="onecol">
      <div id="allRequests"></div>
    </div>
  </div>

  <div style="clear:both;float:none;">&nbsp;</div>

  <a id="apisrc" href="#" target="_blank">API Source</a>

  <div style="clear:both;float:none;">&nbsp;</div>

  <button id="showdump" onclick="toggleDump()">Show JSON dump</button>

  <textarea id="dump" style="width:100%;height:80px;"></textarea>

  <script async src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" onload="init()"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/d3js/5.7.0/d3.min.js"></script>

  <style type="text/css">

  body {
    font-family: sans-serif;
    margin:0em;
    border:solid 2em #222;
    padding:4em;
  }

  .preloader {
          width: 100%;
          height: 100%;
          background:#fffc;

          position:absolute; /*it can be fixed too*/
          left:0; right:0;
          top:0; bottom:0;
          margin:auto;
          text-align: center;
          padding-top:40%;
          z-index:10000;

          /*this to solve "the content will not be cut when the window is smaller than the content": */
          max-width:100%;
          max-height:100%;
          overflow:auto;
      }

  div.colbox {
    float:none;
  }
  div.onecol {
    width:100%;
    clear:none;
    float:left;
  }
  div.twocol {
    width:50%;
    clear:none;
    float:left;
  }
  div.row {
    width:100%;
    clear:both;
    padding:2pt;
  }
  div.row > label {
    color:gray;
  }
  div.row > span {
    color:blue;
    margin-left:2pt;
  }
  div.threecol {
    width:33%;
    clear:none;
    float:left;
  }

  .rTable { display: table; }
  .rTableRow { display: table-row; }
  .rTableHeading { display: table-header-group; font-weight:bold; }
  .rTableBody { display: table-row-group; }
  .rTableFoot { display: table-footer-group; }
  .rTableCell, .rTableHead { display: table-cell; border:solid 1px #eee; }

  .rTableCell, .rTableHead { padding:0.2em }
  .rTableHead > .rTableCell { background-color:#ccf }
  .row-label { color:gray; padding-right:1em; }
  .right-align { text-align:right; }
  .center { text-align:center; }
  .rTableCell > span { color:blue; }

  .non-value { color:gray; }
  .good-value { color:green; }
  .bad-value { color:red; }

  .go, .nogo { font-size:2em; padding-top: 3em; font-weight:bold; text-align:center; }
  .go { color:green; }
  .nogo { color:red; }
  div.nogoreasons { font-style:italic; text-align:center; }
  a.nogoreasons:link,a.nogoreasons:active,a.nogoreasons:visited,a.nogoreasons:hover { color:gray; }
  .timestamp { color:gray; display:none; }
  </style>
</body>
</html>
